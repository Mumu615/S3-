我来为您设计一个完整的Node.js S3图床服务开发文档，使用MySQL数据库，并配置您提供的ClawCloud对象存储。

# Node.js S3图床服务开发文档

## 项目概述

基于Node.js + Express + MySQL的S3图床服务，支持图片上传、管理、批量删除，通过哈希值去重，使用ClawCloud对象存储作为后端存储。

## 技术栈

- **运行环境**: Node.js 16+
- **Web框架**: Express.js
- **数据库**: MySQL 8.0+
- **ORM**: Sequelize
- **S3客户端**: aws-sdk
- **文件处理**: Multer
- **加密**: Crypto (SHA-256)
- **环境配置**: dotenv

## 项目结构

```
s3-image-host/
├── src/
│   ├── config/
│   │   ├── database.js
│   │   └── s3.js
│   ├── controllers/
│   │   ├── uploadController.js
│   │   └── imageController.js
│   ├── middleware/
│   │   ├── upload.js
│   │   └── error.js
│   ├── models/
│   │   └── Image.js
│   ├── routes/
│   │   ├── upload.js
│   │   └── images.js
│   ├── services/
│   │   ├── imageService.js
│   │   └── s3Service.js
│   ├── utils/
│   │   ├── hash.js
│   │   └── response.js
│   └── app.js
├── uploads/           # 临时上传目录
├── .env
├── package.json
└── README.md
```

## 数据库设计

### MySQL表结构

```sql
CREATE DATABASE IF NOT EXISTS image_hosting;
USE image_hosting;

CREATE TABLE images (
    id INT AUTO_INCREMENT PRIMARY KEY,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    url VARCHAR(500) NOT NULL,
    file_hash VARCHAR(64) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    upload_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
  
    INDEX idx_hash (file_hash),
    INDEX idx_upload_time (upload_time),
    INDEX idx_is_deleted (is_deleted),
    UNIQUE KEY unique_filename (filename)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 核心配置

### .env 环境配置

```env
# 服务器配置
PORT=3000
NODE_ENV=development

# MySQL数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=image_hosting
DB_USER=root
DB_PASSWORD=your_password

# ClawCloud S3配置
S3_ACCESS_KEY=eva7a2jd
S3_SECRET_KEY=q745r8kl6jj7mwft
S3_ENDPOINT=objectstorageapi.ap-southeast-1.clawcloudrun.com
S3_REGION=ap-southeast-1
S3_BUCKET=your-bucket-name

# 上传限制
MAX_FILE_SIZE=10485760  # 10MB
ALLOWED_MIME_TYPES=image/jpeg,image/png,image/gif,image/webp
```

### S3配置 (src/config/s3.js)

```javascript
const AWS = require('aws-sdk');
require('dotenv').config();

const s3Config = new AWS.S3({
  accessKeyId: process.env.S3_ACCESS_KEY,
  secretAccessKey: process.env.S3_SECRET_KEY,
  endpoint: process.env.S3_ENDPOINT,
  region: process.env.S3_REGION,
  s3ForcePathStyle: true,  // 重要：兼容S3 API需要
  signatureVersion: 'v4',
  apiVersion: '2006-03-01'
});

const bucketName = process.env.S3_BUCKET;

module.exports = {
  s3: s3Config,
  bucketName
};
```

### 数据库配置 (src/config/database.js)

```javascript
const { Sequelize } = require('sequelize');
require('dotenv').config();

const sequelize = new Sequelize(
  process.env.DB_NAME,
  process.env.DB_USER,
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    dialect: 'mysql',
    logging: process.env.NODE_ENV === 'development' ? console.log : false,
    pool: {
      max: 10,
      min: 0,
      acquire: 30000,
      idle: 10000
    }
  }
);

module.exports = sequelize;
```

## 核心功能实现

### 1. 数据模型 (src/models/Image.js)

```javascript
const { DataTypes } = require('sequelize');
const sequelize = require('../config/database');

const Image = sequelize.define('Image', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  filename: {
    type: DataTypes.STRING(255),
    allowNull: false,
    unique: true
  },
  originalName: {
    type: DataTypes.STRING(255),
    allowNull: false,
    field: 'original_name'
  },
  url: {
    type: DataTypes.STRING(500),
    allowNull: false
  },
  fileHash: {
    type: DataTypes.STRING(64),
    allowNull: false,
    field: 'file_hash'
  },
  fileSize: {
    type: DataTypes.BIGINT,
    allowNull: false,
    field: 'file_size'
  },
  mimeType: {
    type: DataTypes.STRING(100),
    allowNull: false,
    field: 'mime_type'
  },
  uploadTime: {
    type: DataTypes.DATE,
    defaultValue: DataTypes.NOW,
    field: 'upload_time'
  },
  isDeleted: {
    type: DataTypes.BOOLEAN,
    defaultValue: false,
    field: 'is_deleted'
  }
}, {
  tableName: 'images',
  timestamps: true,
  createdAt: 'upload_time',
  updatedAt: 'updated_at'
});

module.exports = Image;
```

### 2. 哈希工具 (src/utils/hash.js)

```javascript
const crypto = require('crypto');

/**
 * 计算文件的SHA256哈希值
 * @param {Buffer} buffer - 文件buffer
 * @returns {string} 哈希值
 */
function calculateFileHash(buffer) {
  return crypto.createHash('sha256').update(buffer).digest('hex');
}

module.exports = {
  calculateFileHash
};
```

### 3. S3服务 (src/services/s3Service.js)

```javascript
const { s3, bucketName } = require('../config/s3');

class S3Service {
  /**
   * 上传文件到S3
   * @param {Buffer} buffer - 文件buffer
   * @param {string} filename - 文件名
   * @param {string} mimeType - 文件类型
   * @returns {Promise<Object>} 上传结果
   */
  async uploadFile(buffer, filename, mimeType) {
    const params = {
      Bucket: bucketName,
      Key: filename,
      Body: buffer,
      ContentType: mimeType,
      ACL: 'public-read'
    };

    try {
      const result = await s3.upload(params).promise();
      return {
        success: true,
        url: result.Location,
        etag: result.ETag
      };
    } catch (error) {
      console.error('S3上传失败:', error);
      throw new Error('S3上传失败');
    }
  }

  /**
   * 删除S3文件
   * @param {string} filename - 文件名
   * @returns {Promise<boolean>} 删除结果
   */
  async deleteFile(filename) {
    const params = {
      Bucket: bucketName,
      Key: filename
    };

    try {
      await s3.deleteObject(params).promise();
      return true;
    } catch (error) {
      console.error('S3删除失败:', error);
      throw new Error('S3删除失败');
    }
  }

  /**
   * 批量删除S3文件
   * @param {string[]} filenames - 文件名数组
   * @returns {Promise<Object>} 删除结果
   */
  async deleteFiles(filenames) {
    const deleteParams = {
      Bucket: bucketName,
      Delete: {
        Objects: filenames.map(filename => ({ Key: filename }))
      }
    };

    try {
      const result = await s3.deleteObjects(deleteParams).promise();
      return {
        success: true,
        deleted: result.Deleted,
        errors: result.Errors
      };
    } catch (error) {
      console.error('S3批量删除失败:', error);
      throw new Error('S3批量删除失败');
    }
  }

  /**
   * 检查文件是否存在
   * @param {string} filename - 文件名
   * @returns {Promise<boolean>} 是否存在
   */
  async fileExists(filename) {
    const params = {
      Bucket: bucketName,
      Key: filename
    };

    try {
      await s3.headObject(params).promise();
      return true;
    } catch (error) {
      return false;
    }
  }
}

module.exports = new S3Service();
```

### 4. 图片服务 (src/services/imageService.js)

```javascript
const Image = require('../models/Image');
const { calculateFileHash } = require('../utils/hash');
const s3Service = require('./s3Service');

class ImageService {
  /**
   * 上传图片（带去重检查）
   * @param {Object} fileData - 文件数据
   * @returns {Promise<Object>} 上传结果
   */
  async uploadImage(fileData) {
    const { buffer, originalname, mimetype } = fileData;
  
    // 计算文件哈希
    const fileHash = calculateFileHash(buffer);
  
    // 检查是否已存在相同哈希的图片
    const existingImage = await Image.findOne({
      where: { 
        fileHash,
        isDeleted: false 
      }
    });

    if (existingImage) {
      return {
        success: true,
        duplicate: true,
        data: {
          id: existingImage.id,
          url: existingImage.url,
          filename: existingImage.filename,
          originalName: existingImage.originalName,
          fileSize: existingImage.fileSize,
          uploadTime: existingImage.uploadTime
        }
      };
    }

    // 生成唯一文件名
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000);
    const extension = originalname.split('.').pop();
    const filename = `${timestamp}_${random}.${extension}`;

    // 上传到S3
    const uploadResult = await s3Service.uploadFile(buffer, filename, mimetype);

    // 保存到数据库
    const newImage = await Image.create({
      filename,
      originalName: originalname,
      url: uploadResult.url,
      fileHash,
      fileSize: buffer.length,
      mimeType: mimetype
    });

    return {
      success: true,
      duplicate: false,
      data: {
        id: newImage.id,
        url: newImage.url,
        filename: newImage.filename,
        originalName: newImage.originalName,
        fileSize: newImage.fileSize,
        uploadTime: newImage.uploadTime
      }
    };
  }

  /**
   * 获取图片列表
   * @param {Object} options - 查询选项
   * @returns {Promise<Object>} 查询结果
   */
  async getImages(options = {}) {
    const { 
      page = 1, 
      limit = 20, 
      search = '', 
      sortBy = 'upload_time', 
      sortOrder = 'DESC' 
    } = options;

    const offset = (page - 1) * limit;
    const where = {
      isDeleted: false
    };

    // 搜索条件
    if (search) {
      where.originalName = {
        [require('sequelize').Op.like]: `%${search}%`
      };
    }

    const { count, rows } = await Image.findAndCountAll({
      where,
      order: [[sortBy, sortOrder.toUpperCase()]],
      limit: parseInt(limit),
      offset: parseInt(offset)
    });

    return {
      success: true,
      data: {
        images: rows,
        pagination: {
          currentPage: page,
          totalPages: Math.ceil(count / limit),
          totalItems: count,
          hasNext: page < Math.ceil(count / limit),
          hasPrev: page > 1
        }
      }
    };
  }

  /**
   * 删除单个图片
   * @param {number} id - 图片ID
   * @returns {Promise<Object>} 删除结果
   */
  async deleteImage(id) {
    const image = await Image.findOne({
      where: { id, isDeleted: false }
    });

    if (!image) {
      return {
        success: false,
        message: '图片不存在'
      };
    }

    try {
      // 从S3删除文件
      await s3Service.deleteFile(image.filename);
    
      // 软删除数据库记录
      await image.update({ isDeleted: true });

      return {
        success: true,
        message: '删除成功'
      };
    } catch (error) {
      return {
        success: false,
        message: '删除失败: ' + error.message
      };
    }
  }

  /**
   * 批量删除图片
   * @param {number[]} ids - 图片ID数组
   * @returns {Promise<Object>} 删除结果
   */
  async deleteImages(ids) {
    const images = await Image.findAll({
      where: {
        id: ids,
        isDeleted: false
      }
    });

    if (images.length === 0) {
      return {
        success: false,
        message: '没有找到要删除的图片'
      };
    }

    try {
      // 从S3批量删除文件
      const filenames = images.map(img => img.filename);
      await s3Service.deleteFiles(filenames);
    
      // 批量软删除数据库记录
      await Image.update(
        { isDeleted: true },
        {
          where: {
            id: ids
          }
        }
      );

      return {
        success: true,
        message: `成功删除${images.length}张图片`,
        data: {
          deletedCount: images.length
        }
      };
    } catch (error) {
      return {
        success: false,
        message: '批量删除失败: ' + error.message
      };
    }
  }

  /**
   * 获取单个图片信息
   * @param {number} id - 图片ID
   * @returns {Promise<Object>} 图片信息
   */
  async getImage(id) {
    const image = await Image.findOne({
      where: { id, isDeleted: false }
    });

    if (!image) {
      return {
        success: false,
        message: '图片不存在'
      };
    }

    return {
      success: true,
      data: image
    };
  }
}

module.exports = new ImageService();
```

### 5. 上传控制器 (src/controllers/uploadController.js)

```javascript
const imageService = require('../services/imageService');
const { successResponse, errorResponse } = require('../utils/response');

class UploadController {
  /**
   * 单文件上传
   */
  async uploadSingle(req, res) {
    try {
      if (!req.file) {
        return errorResponse(res, '请选择要上传的文件', 400);
      }

      const result = await imageService.uploadImage({
        buffer: req.file.buffer,
        originalname: req.file.originalname,
        mimetype: req.file.mimetype
      });

      if (result.success) {
        const message = result.duplicate ? '图片已存在，返回已有链接' : '上传成功';
        return successResponse(res, result.data, message);
      } else {
        return errorResponse(res, result.message, 500);
      }
    } catch (error) {
      console.error('上传错误:', error);
      return errorResponse(res, '上传失败', 500);
    }
  }

  /**
   * 多文件上传
   */
  async uploadMultiple(req, res) {
    try {
      if (!req.files || req.files.length === 0) {
        return errorResponse(res, '请选择要上传的文件', 400);
      }

      const uploadPromises = req.files.map(file => 
        imageService.uploadImage({
          buffer: file.buffer,
          originalname: file.originalname,
          mimetype: file.mimetype
        })
      );

      const results = await Promise.all(uploadPromises);
    
      const successful = results.filter(r => r.success);
      const failed = results.filter(r => !r.success);

      return successResponse(res, {
        successful,
        failed,
        totalUploaded: successful.length,
        totalFailed: failed.length
      }, `上传完成: 成功${successful.length}个，失败${failed.length}个`);
    } catch (error) {
      console.error('批量上传错误:', error);
      return errorResponse(res, '批量上传失败', 500);
    }
  }
}

module.exports = new UploadController();
```

### 6. 图片控制器 (src/controllers/imageController.js)

```javascript
const imageService = require('../services/imageService');
const { successResponse, errorResponse } = require('../utils/response');

class ImageController {
  /**
   * 获取图片列表
   */
  async getList(req, res) {
    try {
      const { page, limit, search, sortBy, sortOrder } = req.query;
    
      const result = await imageService.getImages({
        page: parseInt(page) || 1,
        limit: parseInt(limit) || 20,
        search: search || '',
        sortBy: sortBy || 'upload_time',
        sortOrder: sortOrder || 'DESC'
      });

      return successResponse(res, result.data);
    } catch (error) {
      console.error('获取图片列表错误:', error);
      return errorResponse(res, '获取失败', 500);
    }
  }

  /**
   * 获取单个图片
   */
  async getOne(req, res) {
    try {
      const { id } = req.params;
      const result = await imageService.getImage(id);

      if (result.success) {
        return successResponse(res, result.data);
      } else {
        return errorResponse(res, result.message, 404);
      }
    } catch (error) {
      console.error('获取图片错误:', error);
      return errorResponse(res, '获取失败', 500);
    }
  }

  /**
   * 删除单个图片
   */
  async deleteOne(req, res) {
    try {
      const { id } = req.params;
      const result = await imageService.deleteImage(id);

      if (result.success) {
        return successResponse(res, null, result.message);
      } else {
        return errorResponse(res, result.message, 404);
      }
    } catch (error) {
      console.error('删除图片错误:', error);
      return errorResponse(res, '删除失败', 500);
    }
  }

  /**
   * 批量删除图片
   */
  async deleteMultiple(req, res) {
    try {
      const { ids } = req.body;

      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return errorResponse(res, '请提供要删除的图片ID数组', 400);
      }

      if (ids.length > 100) {
        return errorResponse(res, '单次最多删除100张图片', 400);
      }

      const result = await imageService.deleteImages(ids);

      if (result.success) {
        return successResponse(res, result.data, result.message);
      } else {
        return errorResponse(res, result.message, 500);
      }
    } catch (error) {
      console.error('批量删除错误:', error);
      return errorResponse(res, '批量删除失败', 500);
    }
  }
}

module.exports = new ImageController();
```

### 7. 路由配置

#### 上传路由 (src/routes/upload.js)

```javascript
const express = require('express');
const multer = require('multer');
const path = require('path');
const uploadController = require('../controllers/uploadController');
const { validateFile } = require('../middleware/upload');

const router = express.Router();

// 配置multer存储
const storage = multer.memoryStorage();

// 文件过滤器
const fileFilter = (req, file, cb) => {
  const allowedTypes = process.env.ALLOWED_MIME_TYPES.split(',');
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('不支持的文件类型'), false);
  }
};

const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: parseInt(process.env.MAX_FILE_SIZE) || 10 * 1024 * 1024
  }
});

// 单文件上传
router.post('/', upload.single('image'), uploadController.uploadSingle);

// 多文件上传
router.post('/multiple', upload.array('images', 10), uploadController.uploadMultiple);

module.exports = router;
```

#### 图片管理路由 (src/routes/images.js)

```javascript
const express = require('express');
const imageController = require('../controllers/imageController');

const router = express.Router();

// 获取图片列表
router.get('/', imageController.getList);

// 获取单个图片
router.get('/:id', imageController.getOne);

// 删除单个图片
router.delete('/:id', imageController.deleteOne);

// 批量删除图片
router.delete('/', imageController.deleteMultiple);

module.exports = router;
```

### 8. 主应用 (src/app.js)

```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');

const sequelize = require('./config/database');
const uploadRoutes = require('./routes/upload');
const imageRoutes = require('./routes/images');
const errorMiddleware = require('./middleware/error');

const app = express();
const PORT = process.env.PORT || 3000;

// 安全中间件
app.use(helmet());
app.use(cors());

// 压缩中间件
app.use(compression());

// 限流中间件
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 限制每个IP 15分钟内最多100个请求
  message: '请求过于频繁，请稍后再试'
});
app.use('/api/', limiter);

// 解析中间件
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// 路由
app.use('/api/upload', uploadRoutes);
app.use('/api/images', imageRoutes);

// 健康检查
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// 404处理
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    message: '接口不存在'
  });
});

// 错误处理中间件
app.use(errorMiddleware);

// 数据库连接和服务器启动
async function startServer() {
  try {
    await sequelize.authenticate();
    console.log('数据库连接成功');
  
    // 同步数据库模型
    await sequelize.sync({ alter: true });
    console.log('数据库模型同步完成');

    app.listen(PORT, () => {
      console.log(`服务器运行在端口 ${PORT}`);
      console.log(`健康检查: http://localhost:${PORT}/health`);
    });
  } catch (error) {
    console.error('服务器启动失败:', error);
    process.exit(1);
  }
}

startServer();
```

### 9. 工具函数

#### 响应工具 (src/utils/response.js)

```javascript
/**
 * 成功响应
 * @param {Object} res - Express响应对象
 * @param {*} data - 响应数据
 * @param {string} message - 响应消息
 */
function successResponse(res, data = null, message = '操作成功') {
  res.status(200).json({
    success: true,
    message,
    data,
    timestamp: new Date().toISOString()
  });
}

/**
 * 错误响应
 * @param {Object} res - Express响应对象
 * @param {string} message - 错误消息
 * @param {number} statusCode - HTTP状态码
 */
function errorResponse(res, message = '操作失败', statusCode = 500) {
  res.status(statusCode).json({
    success: false,
    message,
    data: null,
    timestamp: new Date().toISOString()
  });
}

module.exports = {
  successResponse,
  errorResponse
};
```

## API接口文档

### 1. 上传接口

#### 单文件上传
```
POST /api/upload
Content-Type: multipart/form-data

Body:
- image: File (图片文件)

Response:
{
  "success": true,
  "message": "上传成功",
  "data": {
    "id": 1,
    "url": "https://bucket.s3.endpoint.com/filename.jpg",
    "filename": "1640995200000_123.jpg",
    "originalName": "myphoto.jpg",
    "fileSize": 1024000,
    "uploadTime": "2023-12-31T16:00:00.000Z"
  },
  "timestamp": "2023-12-31T16:00:00.000Z"
}
```

#### 多文件上传
```
POST /api/upload/multiple
Content-Type: multipart/form-data

Body:
- images: File[] (图片文件数组，最多10个)

Response:
{
  "success": true,
  "message": "上传完成: 成功3个，失败0个",
  "data": {
    "successful": [...],
    "failed": [...],
    "totalUploaded": 3,
    "totalFailed": 0
  }
}
```

### 2. 图片管理接口

#### 获取图片列表
```
GET /api/images?page=1&limit=20&search=keyword&sortBy=upload_time&sortOrder=DESC

Response:
{
  "success": true,
  "data": {
    "images": [...],
    "pagination": {
      "currentPage": 1,
      "totalPages": 5,
      "totalItems": 100,
      "hasNext": true,
      "hasPrev": false
    }
  }
}
```

#### 获取单个图片
```
GET /api/images/:id

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "filename": "1640995200000_123.jpg",
    "originalName": "myphoto.jpg",
    "url": "https://bucket.s3.endpoint.com/filename.jpg",
    "fileSize": 1024000,
    "mimeType": "image/jpeg",
    "uploadTime": "2023-12-31T16:00:00.000Z"
  }
}
```

#### 删除单个图片
```
DELETE /api/images/:id

Response:
{
  "success": true,
  "message": "删除成功"
}
```

#### 批量删除图片
```
DELETE /api/images
Content-Type: application/json

Body:
{
  "ids": [1, 2, 3]
}

Response:
{
  "success": true,
  "message": "成功删除3张图片",
  "data": {
    "deletedCount": 3
  }
}
```

## 部署说明

### 1. 依赖安装

```bash
npm init -y
npm install express sequelize mysql2 aws-sdk multer helmet cors compression express-rate-limit dotenv crypto
```

### 2. 数据库初始化

```bash
# 创建数据库和表
mysql -u root -p < database.sql
```

### 3. 环境配置

复制 `.env.example` 为 `.env` 并配置相应参数。

### 4. 启动服务

```bash
# 开发环境
npm run dev

# 生产环境
npm start
```

## 补充建议

### 1. 性能优化
- **图片压缩**: 集成sharp库进行自动压缩
- **缩略图生成**: 自动生成不同尺寸的缩略图
- **CDN加速**: 使用CDN加速图片访问
- **缓存策略**: Redis缓存热点图片信息

### 2. 安全增强
- **API鉴权**: JWT或OAuth2.0认证
- **文件验证**: 更严格的文件类型检查
- **访问日志**: 详细的访问日志记录
- **IP白名单**: 限制API访问来源

### 3. 监控运维
- **健康检查**: 完善的健康检查接口
- **错误监控**: 集成错误监控服务
- **性能监控**: API响应时间监控
- **日志管理**: 结构化日志输出

### 4. 扩展功能
- **图片分类**: 支持图片分类和标签
- **批量操作**: 支持更多批量操作
- **统计报表**: 上传统计和分析
- **备份策略**: 定期数据备份

这个方案提供了一个完整、可扩展的S3图床服务，使用MySQL存储元数据，支持您的ClawCloud对象存储配置，包含了您要求的所有核心功能。